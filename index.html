<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Purple Pepe Moon Runner ‚Äì Perspective</title>
<style>
  :root{--bg1:#0b0220;--bg2:#17053a;--lane:#24164a;--glow:#9c4dff;--danger:#ff6a5e}
  html,body{margin:0;height:100%;background:linear-gradient(var(--bg1),var(--bg2));color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
  #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{width:min(100vw,540px);aspect-ratio:9/16;display:block}
  #hud{position:fixed;top:env(safe-area-inset-top,8px);left:50%;transform:translateX(-50%);width:min(100vw,540px);display:flex;justify-content:space-between;padding:6px 10px;box-sizing:border-box;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  .pill{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px}
  #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
  #panel{width:min(92vw,420px);background:#14092c;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px}
  #panel h1{margin:.3em 0 .4em;font-size:22px}
  #panel .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid #6a34d6;background:linear-gradient(180deg,#9c4dff,#6a34d6);color:#fff;font-weight:800}
</style>
</head>
<body>
<div id="wrap"><canvas id="cv"></canvas></div>
<div id="hud"><div class="pill" id="score">Score: 0</div><div class="pill" id="best">Best: 0</div></div>
<div id="overlay"><div id="panel">
  <h1>üíú Purple Pepe Moon Runner</h1>
  <p>Wische ‚Üê/‚Üí zum Spurwechsel, ‚Üë zum Springen, ‚Üì Ducken. Tippe zum Start.</p>
  <div style="text-align:center;margin-top:10px"><button class="btn" id="play">‚ñ∂Ô∏é Spielen</button></div>
</div></div>

<script>
/* ===== Canvas + sizing ===== */
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
function fit(){const w=Math.min(innerWidth,540);cv.width=w;cv.height=Math.round(w*16/9)};addEventListener('resize',fit,{passive:true});fit();
let W=cv.width,H=cv.height;

/* ===== ‚Äú3D‚Äù camera params ===== */
const horizon = H*0.32;          // Horizont-Y
const vpX = W*0.5;               // Vanishing point X
const FOV = 260;                 // Brennweite (je h√∂her, desto mehr Tiefe)
const laneWorldHalf = 1.2;       // halbe Breite einer Spur in ‚ÄúWelt‚Äù-Einheiten
const laneCenters = [-1,0,1];    // drei Spuren in Weltkoords (x = -1,0,1)

/* Welt‚ÜíScreen Projektionsfunktionen */
function projX(wx, wz){ return vpX + (wx * FOV / (wz||.0001)); }
function projY(wz){      return horizon + (FOV / (wz||.0001)); }
function projS(wz){      return Math.max(0.15, FOV / (wz||.0001)); } // Scale

/* ===== Game state ===== */
const state={playing:false,score:0,best:+(localStorage.moonBest||0),t:0,speed:0.25}; // speed in z‚ÄëEinheiten/Frame
let lane=1;
const player={wx:0,wz:3.5,vy:0,onGround:true,duck:false}; // Spieler steht in Z‚âà3.5, Weltkoords
let objs=[]; // Hindernisse mit {type:'meteor'|'junk', wx, wz, rot}

/* ===== Input (touch + keys) ===== */
let sx=0,sy=0,sw=false;
cv.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;sw=true;if(!state.playing) start();},{passive:true});
cv.addEventListener('touchmove',e=>{
  if(!sw) return; const t=e.touches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
  if(Math.abs(dx)>40||Math.abs(dy)>40){
    if(Math.abs(dx)>Math.abs(dy)){ if(dx>0&&lane<2) lane++; if(dx<0&&lane>0) lane--; }
    else { if(dy<-30) jump(); if(dy>30) {player.duck=true; setTimeout(()=>player.duck=false,220);} }
    sw=false;
  }
},{passive:true});
addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft'&&lane>0) lane--;
  if(e.key==='ArrowRight'&&lane<2) lane++;
  if(e.key==='ArrowUp') jump();
  if(e.key==='ArrowDown'){player.duck=true; setTimeout(()=>player.duck=false,220);}
  if(e.key===' '&&!state.playing) start();
});

/* ===== Start/Restart ===== */
document.getElementById('play').onclick=()=>start();
function start(){ objs.length=0; state.t=0; state.speed=0.25; state.score=0; lane=1; player.wx=0; player.wz=3.5; player.vy=0; player.onGround=true; player.duck=false; document.getElementById('overlay').style.display='none'; state.playing=true; }

/* ===== Spawner ===== */
function spawn(){
  // alle ~22 Ticks: ein Objekt hinten am Horizont (z gro√ü) in zuf√§lliger Spur
  if(state.t%22===0){
    const li=Math.floor(Math.random()*3);
    const type = Math.random()<0.7?'meteor':'junk';
    objs.push({type, wx: laneCenters[li]*(laneWorldHalf*1.2), wz: 120 + Math.random()*40, rot: Math.random()*Math.PI});
  }
}

/* ===== Drawing helpers ===== */
function drawRoad(){
  // drei Lane-Trapeze nach vorne (z Staffeln)
  const bands=8;
  for(let i=0;i<bands;i++){
    const z0 = i*15+4, z1 = (i+1)*15+4;
    // Kanten links/rechts der Stra√üe (3 Spuren breit)
    const left0  = projX(-laneWorldHalf*3, z0), right0 = projX(laneWorldHalf*3, z0);
    const left1  = projX(-laneWorldHalf*3, z1), right1 = projX(laneWorldHalf*3, z1);
    ctx.fillStyle = i%2? 'rgba(255,255,255,.03)' : 'rgba(255,255,255,.05)';
    ctx.beginPath(); ctx.moveTo(left0, projY(z0)); ctx.lineTo(right0, projY(z0));
    ctx.lineTo(right1, projY(z1)); ctx.lineTo(left1, projY(z1)); ctx.closePath(); ctx.fill();

    // Spurtrennlinien
    for(let l=-1;l<=1;l++){
      const bx0=projX(l*laneWorldHalf, z0), bx1=projX(l*laneWorldHalf, z1);
      ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(bx0, projY(z0)); ctx.lineTo(bx1, projY(z1)); ctx.stroke();
    }
  }

  // Mondhintergrund & Erde
  ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fillRect(0, projY(6), W, H-projY(6));
  const ex=W*0.82, ey=H*0.18, er=42;
  const eg=ctx.createRadialGradient(ex-er*0.2,ey-er*0.2,er*0.2,ex,ey,er);
  eg.addColorStop(0,'#3cf'); eg.addColorStop(1,'#043'); ctx.fillStyle=eg; ctx.beginPath(); ctx.arc(ex,ey,er,0,Math.PI*2); ctx.fill();
}

function drawPepe(){
  const targetX = laneCenters[lane]*(laneWorldHalf*1.2);
  player.wx += (targetX - player.wx)*0.18;
  // ‚ÄûPhysik‚Äú in Y (springen)
  if(!player.onGround){ player.vy += 0.018; player.wz += player.vy; if(player.wz>=3.5){player.wz=3.5; player.vy=0; player.onGround=true;} }

  const s = projS(player.wz);
  const x = projX(player.wx, player.wz), y = projY(player.wz);
  ctx.save(); ctx.translate(x,y-(player.duck?2:8)); ctx.scale(s,s);

  // Schatten
  ctx.fillStyle='rgba(0,0,0,.35)'; ctx.beginPath(); ctx.ellipse(0,26,18,6,0,0,Math.PI*2); ctx.fill();

  // Suit
  ctx.fillStyle='#dfe6ff'; round(-14,-2,28,34,10);
  ctx.fillStyle='#b9c3ff'; round(-10,4,20,14,6);
  // Kopf & Helm
  ctx.fillStyle='#dfe6ff'; ctx.beginPath(); ctx.arc(0,-16,16,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#9fb3ff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,-16,18,0,Math.PI*2); ctx.stroke();
  // Purple Pepe face
  ctx.fillStyle='#6d31d6'; ctx.beginPath(); ctx.arc(0,-16,13,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(-5,-18,5,0,Math.PI*2); ctx.arc(5,-18,5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-6,-19,2.6,0,Math.PI*2); ctx.arc(4,-19,2.6,0,Math.PI*2); ctx.fill();

  // Visor shine
  ctx.strokeStyle='rgba(255,255,255,.55)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(-2,-20,14,-1.1,-0.5); ctx.stroke();
  ctx.restore();
}

function drawBear(){
  // Deko‚ÄëChaser: hinter Spieler, z gr√∂√üer ‚Üí kleiner gezeichnet
  const wz = 8 + 2*Math.sin(state.t*0.02);
  const wx = player.wx; const s = projS(wz)*0.7;
  const x=projX(wx,wz), y=projY(wz);
  ctx.save(); ctx.translate(x,y-6); ctx.scale(s,s); ctx.globalAlpha=.8;
  round(-12,-4,24,22,8); // body suit
  ctx.fillStyle='#7a5433'; ctx.beginPath(); ctx.arc(0,-18,10,0,Math.PI*2); ctx.fill(); // head
  ctx.strokeStyle='#9fb3ff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,-18,12,0,Math.PI*2); ctx.stroke(); // helmet ring
  ctx.restore();
}

function drawObj(o){
  const s = projS(o.wz);
  const x = projX(o.wx, o.wz), y = projY(o.wz);
  ctx.save(); ctx.translate(x,y); ctx.scale(s,s); ctx.rotate(o.rot+= (o.type==='meteor'?0.06:0.03));
  if(o.type==='meteor'){
    const g=ctx.createRadialGradient(0,0,3,0,0,22); g.addColorStop(0,'#ffd16b'); g.addColorStop(1,'rgba(255,90,80,.08)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,22,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#c94f3d'; ctx.beginPath(); ctx.ellipse(0,0,16,12,0,0,Math.PI*2); ctx.fill();
  }else{
    ctx.fillStyle='#7ec7ff'; round(-22,-10,44,20,6);
  }
  ctx.restore();
}

function round(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.fill();}

/* ===== Loop ===== */
function loop(){
  requestAnimationFrame(loop);
  // Clear + space gradient
  const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0b0220'); g.addColorStop(1,'#17053a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  drawRoad();      // perspektivische Stra√üe
  drawBear();      // Chaser

  if(state.playing){
    state.t++;
    // Spawn & advance
    spawn();
    // Objekte n√§hern sich (Z nimmt ab ‚Üí wird gr√∂√üer)
    for(const o of objs){ o.wz -= state.speed*(1+0.15*Math.random()); }
    // Collision (im Nahbereich z‚âà3.2..3.9)
    for(const o of objs){
      if(o.wz<4 && o.wz>3){
        const px = player.wx, ox = o.wx;
        if(Math.abs(px-ox) < laneWorldHalf*0.65 && !player.duck){ // simple hitbox
          return gameOver();
        }
      }
    }
    // Entferne durchgelaufene
    objs = objs.filter(o=>o.wz>2.5);

    // Difficulty ramp
    if(state.t%240===0) state.speed = Math.min(state.speed+0.06, 0.6);

    // Player & Score
    drawPepe();
    state.score += 1+Math.floor(state.speed*10);
    document.getElementById('score').textContent='Score: '+state.score;
    const best = state.best = Math.max(state.best, state.score);
    document.getElementById('best').textContent='Best: '+best;
  } else {
    // Idle‚ÄëPepe im Men√º
    drawPepe(); 
  }
}
requestAnimationFrame(loop);

function jump(){ if(player.onGround){ player.onGround=false; player.vy=-0.22; } }
function gameOver(){
  state.playing=false;
  localStorage.moonBest = state.best;
  document.getElementById('overlay').style.display='flex';
  document.getElementById('play').textContent='‚Üª Nochmal';
}
</script>
</body>
</html>
